{% extends "base.html" %}
{% block content %}
  <h1>Gmail Submit</h1>
  <div class="card">
    <p class="muted">Logged in as: <b>{{ user.username }}</b> | <a href="/logout">Logout</a></p>
    {% if error %}<p style="color:red; margin-top:10px;"><b>{{ error }}</b></p>{% endif %}
    {% if success %}<p style="color:green; margin-top:10px;"><b>{{ success }}</b></p>{% endif %}
  </div>

  <div class="card">
    <h3>Step 1: Enter Gmail</h3>
    <form method="post" action="/user/gmail/start" class="input-group">
      <input class="email-input" name="gmail" type="email" placeholder="example@gmail.com" required value="{{ draft.gmail if draft else '' }}">
      <button class="submit-btn" type="submit">Start Now</button>
    </form>
  </div>

  {% if draft and draft.gmail %}
    <div class="card">
      <h3>Generated Info</h3>
      <ul style="margin-top:10px; padding-left:18px;">
        <li>Gmail: <b>{{ draft.gmail }}</b></li>
        <li>Password: <b>{{ draft.gen_password }}</b></li>
        <li>Recovery Email: <b>{{ draft.recovery_email }}</b></li>
      </ul>

      <h3 style="margin-top:16px;">Step 2: Upload Authenticator QR Screenshot</h3>
      <p class="muted">টিপস: QR যেন পরিষ্কার দেখা যায়—QR অংশটা zoom করে screenshot দিন।</p>
      <form method="post" action="/user/gmail/upload-qr" enctype="multipart/form-data" class="input-group" style="flex-direction:column; gap:12px;">
        <input class="email-input" type="file" name="qr_image" accept="image/*" required>
        <button class="submit-btn" type="submit">Extract Secret</button>
      </form>
    </div>
  {% endif %}

  {% if draft and draft.secret %}
    <div class="card">
      <h3>Secret Key</h3>
      <p><b>{{ draft.secret }}</b></p>

      <h3 style="margin-top:16px;">Live Authenticator Code</h3>
      <div style="font-size:40px; font-weight:bold;" id="totp_code">------</div>
      <div class="muted" id="totp_meta">Loading...</div>

      <script>
        async function refreshTotp() {
          try {
            const r = await fetch("/user/gmail/totp", {cache: "no-store"});
            const j = await r.json();
            if (!j.ok) {
              document.getElementById("totp_code").innerText = "------";
              document.getElementById("totp_meta").innerText = j.error || "No secret";
              return;
            }
            document.getElementById("totp_code").innerText = j.code;
            document.getElementById("totp_meta").innerText = `Refresh in ${j.remaining}s (period ${j.period}s)`;
          } catch (e) {
            document.getElementById("totp_meta").innerText = "Error fetching code";
          }
        }
        refreshTotp();
        setInterval(refreshTotp, 1000);
      </script>

      <h3 style="margin-top:16px;">Step 3: Submit Job Proof</h3>
      <p class="muted">Job proof format: <code>gmail:password:recovery_email:secret</code></p>

      <form method="post" action="/user/gmail/submit">
        <button class="submit-btn" type="submit">Submit Now</button>
      </form>
    </div>
  {% endif %}

  <div class="card">
    <form method="post" action="/user/gmail/reset">
      <button class="submit-btn" type="submit">Reset Draft</button>
    </form>
  </div>
{% endblock %}
